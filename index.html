<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>HEIC â†’ JPG/PNG/WebP Bulk Converter</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <style>
    :root {
      --bg: #f9fafb; --panel:#ffffff; --muted:#6b7684; --text:#111; --accent:#0077cc; --border:#e2e8f0; --warn:#b45309; --ok:#059669; --error:#b91c1c;
    }
    [data-theme="dark"] {
      --bg: #0b0f14; --panel:#121922; --muted:#97a2af; --text:#e7eef7; --accent:#7fd1b9; --border:#1e2631; --warn:#f59e0b; --ok:#34d399; --error:#ef4444;
    }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--text); font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; transition: background .3s, color .3s; }
    header { padding:28px 20px; text-align:center; border-bottom:1px solid var(--border); background:linear-gradient(180deg, var(--panel), var(--bg)); }
    h1 { margin:0 0 6px; font-size:26px; letter-spacing:.2px; }
    p.sub { margin:0; color:var(--muted); }
    .wrap { max-width:1200px; margin:28px auto; padding:0 16px 40px; }
    .panel { background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:20px; box-shadow: 0 8px 24px rgba(0,0,0,.08); transition: background .3s, border .3s; }
    label { display:block; font-weight:600; margin-bottom:6px; }
    select, input[type="number"], input[type="range"], input[type="text"], button { width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:var(--bg); color:var(--text); transition: background .3s, color .3s, border .3s; }
    select, input[type="range"], button { cursor:pointer; }
    .muted { color: var(--muted); font-size: 13px; }

    .toolbar { display:flex; justify-content:space-between; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    .pill { display:inline-flex; align-items:center; gap:8px; background:var(--bg); border:1px solid var(--border); padding:8px 10px; border-radius:999px; font-size:13px; }
    .inline { width:auto; }

    .row { display:grid; grid-template-columns: 1.2fr 1fr; gap:16px; }
    @media (max-width: 980px){ .row{ grid-template-columns:1fr; } }

    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:10px; margin-top:14px; }
    .card { border:1px solid var(--border); background:var(--bg); border-radius:12px; padding:10px; display:flex; flex-direction:column; gap:8px; position:relative; overflow:hidden; animation: fadeIn .2s ease both; }
    .thumb { width:100%; aspect-ratio: 1/1; border-radius:8px; background:#0b0f140d; display:grid; place-items:center; font-size:12px; color:var(--muted); }
    .x { position:absolute; top:8px; right:8px; background:transparent; border:1px solid var(--border); border-radius:8px; padding:2px 6px; cursor:pointer; backdrop-filter: blur(2px); }

    .list { width:100%; border:1px solid var(--border); border-radius:12px; overflow:hidden; }
    .list thead th { text-align:left; font-size:13px; color:var(--muted); padding:8px 10px; background:var(--bg); border-bottom:1px solid var(--border); }
    .list tbody td { padding:10px; border-bottom:1px solid var(--border); font-size:14px; }
    .status { font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--border); display:inline-block; }
    .status.ok{ background:color-mix(in oklab, var(--ok) 14%, transparent); }
    .status.err{ background:color-mix(in oklab, var(--error) 14%, transparent); }
    .status.run{ background:color-mix(in oklab, var(--accent) 14%, transparent); }

    .drop { border:2px dashed var(--border); border-radius:16px; padding:26px; text-align:center; color:var(--muted); transition:.2s ease border-color, .2s ease background; }
    .drop.drag { border-color: var(--accent); background: rgba(127, 209, 185, .08); }

    .controls { display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; }
    @media (max-width: 980px){ .controls{ grid-template-columns:1fr 1fr; } }
    .actions { display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; align-items:center; }
    .btn { background:var(--accent); color:#fff; border:none; font-weight:700; cursor:pointer; transition: transform .04s ease, background .2s; }
    .btn:active { transform: scale(.98); }
    .btn.secondary { background:transparent; color: var(--text); border:1px solid var(--border); }
    .btn.warn { background:var(--warn); color:#111; }
    .progress { height:10px; background:#cbd5e1; border:1px solid var(--border); border-radius:999px; overflow:hidden; position:relative; }
    [data-theme="dark"] .progress { background:#0c1420; }
    .bar { height:100%; width:0%; background:var(--accent); transition: width .2s ease; }
    .progress.cancelling .bar { background: repeating-linear-gradient(90deg, var(--warn), var(--warn) 12px, transparent 12px, transparent 24px); }

    .errorlog { margin-top:12px; padding:12px; border-radius:12px; border:1px solid var(--border); background:color-mix(in oklab, var(--error) 12%, transparent); display:none; }
    footer { text-align:center; color:var(--muted); padding:30px 10px; }
    .note { font-size:13px; color:var(--muted); margin-top:8px; }

    @keyframes fadeIn { from{opacity:0; transform:translateY(4px);} to{opacity:1; transform:none;} }
  </style>
</head>
<body data-theme="light">
  <header>
    <h1>HEIC â†’ JPG/PNG/WebP Bulk Converter</h1>
    <p class="sub">All in your browser. Drag in HEICs, pick a format, download a .zip.</p>
  </header>

  <main class="wrap">
    <div class="panel">
      <div class="toolbar">
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <div class="pill">
            <label for="themeSelect" class="muted">Theme</label>
            <select id="themeSelect" class="inline">
              <option value="auto">Auto</option>
              <option value="light">Light</option>
              <option value="dark">Dark</option>
            </select>
          </div>
          <div class="pill">
            <label for="preset" class="muted">Preset</label>
            <select id="preset" class="inline">
              <option value="custom">Custom</option>
              <option value="ebay">eBay (JPG 85, 1600px)</option>
              <option value="vinted">Vinted (JPG 85, 2048px)</option>
              <option value="depop">Depop (JPG 90, 2000px)</option>
            </select>
          </div>
          <div class="pill">
            <label for="viewMode" class="muted">View</label>
            <select id="viewMode" class="inline">
              <option value="list">List</option>
              <option value="gallery">Gallery</option>
            </select>
          </div>
          <div class="pill" id="thumbPill" style="display:none;">
            <label for="thumbMode" class="muted">Thumbnails</label>
            <select id="thumbMode" class="inline">
              <option value="auto">Auto</option>
              <option value="on">On</option>
              <option value="off">Off</option>
            </select>
          </div>
          <div class="pill">
            <label for="speedMode" class="muted">Speed</label>
            <select id="speedMode" class="inline">
              <option value="off">Normal</option>
              <option value="on">Speed Mode</option>
            </select>
          </div>
        </div>
        <div class="pill muted" id="summary">0 files</div>
      </div>

      <div id="drop" class="drop" tabindex="0" aria-label="Drop zone. Press Enter to open file picker.">
        <strong>Drag & drop HEIC/HEIF photos here</strong><br/>
        or
        <input id="picker" type="file" accept=".heic,.HEIC,image/heic,image/heif" multiple style="display:block;margin:10px auto 0; max-width:340px;" />
        <div class="note">All processing happens locally in your browser. No uploads.</div>
      </div>

      <div class="row">
        <section>
          <div class="controls" style="margin:14px 0 8px;">
            <div>
              <label for="format">Output format</label>
              <select id="format">
                <option value="image/jpeg">JPEG (.jpg)</option>
                <option value="image/png">PNG (.png)</option>
                <option value="image/webp">WebP (.webp)</option>
              </select>
            </div>
            <div>
              <label for="quality">Quality <span id="qLabel" class="muted">80%</span></label>
              <input id="quality" type="range" min="40" max="100" value="80" />
              <div class="note">Applies to JPEG/WebP. PNG ignores quality.</div>
            </div>
            <div>
              <label for="maxSize">Max side (px)</label>
              <input id="maxSize" type="number" min="512" step="64" value="3000" />
              <div class="note">Optional downscale for faster marketplace uploads.</div>
            </div>
            <div>
              <label for="basename">Filename pattern</label>
              <input id="basename" placeholder="e.g., {sku}-{index} or ebay_{date}_{index}" />
              <div class="note">Tokens: {base} original name, {index} 001â€¦, {date} YYYYMMDD, {time} HHmm, {sku} from CSV.</div>
            </div>
          </div>

          <div class="actions">
            <button id="convert" class="btn">Convert & Zip</button>
            <button id="cancel" class="btn warn" title="Cancel current run" disabled>Cancel</button>
            <button id="clear" class="btn secondary" title="Remove all queued files">Clear</button>
            <span id="count" class="muted" aria-live="polite"></span>
          </div>

          <div style="margin:14px 0">
            <div class="progress" aria-hidden="true"><div class="bar" id="bar"></div></div>
            <div id="status" class="muted" style="margin-top:6px;">Idle.</div>
          </div>

          <div class="pill" style="margin-top:6px; gap:6px;">
            <span>Tips:</span>
            <span class="kbd">âŒ˜/Ctrl + O</span> add files
            <span class="kbd">âŒ˜/Ctrl + Enter</span> convert
            <span class="kbd">Del</span> clear
          </div>

          <div id="errors" class="errorlog" role="status" aria-live="polite"></div>
        </section>

        <section>
          <label for="csv">Optional CSV (map names/SKUs)</label>
          <input id="csv" type="file" accept=".csv" />
          <div class="note">CSV headers supported: <strong>original,new</strong> or <strong>name,sku</strong>. Weâ€™ll use {sku} in your filename pattern.</div>

          <!-- Repository container (List or Gallery) -->
          <div id="repoList" style="margin-top:10px; display:block;"></div>
        </section>
      </div>
    </div>

    <footer>
      Built for quick marketplace prep. Works offline after first load.
    </footer>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <script>
    // ---------- Elements & State ----------
    const drop = document.getElementById('drop');
    const picker = document.getElementById('picker');
    const repoList = document.getElementById('repoList');
    const convertBtn = document.getElementById('convert');
    const cancelBtn = document.getElementById('cancel');
    const clearBtn = document.getElementById('clear');
    const countEl = document.getElementById('count');
    const formatSel = document.getElementById('format');
    const qualityRange = document.getElementById('quality');
    const qLabel = document.getElementById('qLabel');
    const maxSize = document.getElementById('maxSize');
    const baseName = document.getElementById('basename');
    const bar = document.getElementById('bar');
    const statusEl = document.getElementById('status');
    const errorsEl = document.getElementById('errors');
    const themeSelect = document.getElementById('themeSelect');
    const presetSel = document.getElementById('preset');
    const csvInput = document.getElementById('csv');
    const viewModeSel = document.getElementById('viewMode');
    const thumbPill = document.getElementById('thumbPill');
    const thumbModeSel = document.getElementById('thumbMode');
    const speedModeSel = document.getElementById('speedMode');
    const summary = document.getElementById('summary');

    let files = [];             // File[] (originals)
    let items = [];             // {id, file, name, size, status, imgURL?}
    let abort = { cancelled:false };
    let csvMap = new Map();

    // ---------- Theme ----------
    const media = window.matchMedia('(prefers-color-scheme: dark)');
    function resolveTheme(mode){ return mode === 'auto' ? (media.matches ? 'dark' : 'light') : mode; }
    function applyThemeMode(mode){ document.body.setAttribute('data-theme', resolveTheme(mode)); themeSelect.value = mode; localStorage.setItem('themeMode', mode); }
    const savedMode = localStorage.getItem('themeMode') || 'auto';
    applyThemeMode(savedMode);
    themeSelect.addEventListener('change', e=> applyThemeMode(e.target.value));
    media.addEventListener('change', ()=>{ if ((localStorage.getItem('themeMode')||'auto')==='auto') applyThemeMode('auto'); });

    // ---------- Presets ----------
    const presets = {
      custom: null,
      ebay:  { format:'image/jpeg', quality:85, max:1600, pattern:'{base}-{index}' },
      vinted:{ format:'image/jpeg', quality:85, max:2048, pattern:'vinted_{date}_{index}' },
      depop: { format:'image/jpeg', quality:90, max:2000, pattern:'depop_{date}_{index}' }
    };
    presetSel.addEventListener('change', ()=>{
      const p = presets[presetSel.value];
      if(!p) return;
      formatSel.value = p.format; qualityRange.value = p.quality; qLabel.textContent = p.quality+"%"; maxSize.value = p.max; if(!baseName.value) baseName.value = p.pattern;
      persistSettings();
    });

    // ---------- Settings persistence ----------
    function persistSettings(){
      const data = { preset:presetSel.value, format:formatSel.value, quality:qualityRange.value, maxSize:maxSize.value, pattern:baseName.value, view:viewModeSel.value, thumbs:thumbModeSel.value, speed:speedModeSel.value };
      localStorage.setItem('settings', JSON.stringify(data));
    }
    function restoreSettings(){
      try{ const s = JSON.parse(localStorage.getItem('settings')||'{}');
        if(s.preset) presetSel.value = s.preset; if(s.format) formatSel.value = s.format; if(s.quality){ qualityRange.value=s.quality; qLabel.textContent=s.quality+'%'; }
        if(s.maxSize) maxSize.value = s.maxSize; if(s.pattern) baseName.value = s.pattern; if(s.view) viewModeSel.value = s.view; if(s.thumbs) thumbModeSel.value = s.thumbs; if(s.speed) speedModeSel.value = s.speed;
      }catch(_){}
    }
    restoreSettings();

    [formatSel, qualityRange, maxSize, baseName, viewModeSel, thumbModeSel, speedModeSel].forEach(el=> el.addEventListener('change', persistSettings));
    qualityRange.addEventListener('input', ()=>{ qLabel.textContent = qualityRange.value + '%'; persistSettings(); });

    function maybeApplySpeedMode(){ if(speedModeSel.value==='on'){ thumbModeSel.value='off'; formatSel.value='image/jpeg'; qualityRange.value=85; qLabel.textContent='85%'; maxSize.value=1600; } }
    speedModeSel.addEventListener('change', ()=>{ maybeApplySpeedMode(); persistSettings(); });
    maybeApplySpeedMode();

    // ---------- Utilities ----------
    const pad = (num, size=3)=> String(num).padStart(size,'0');
    const kb = n => (n/1024).toFixed(0) + ' KB';
    function extFor(mime){ return mime==='image/png' ? 'png' : (mime==='image/webp'? 'webp':'jpg'); }
    function nowStamp(){ const d=new Date(); const yyyy=d.getFullYear(); const mm=pad(d.getMonth()+1,2); const dd=pad(d.getDate(),2); const HH=pad(d.getHours(),2); const MM=pad(d.getMinutes(),2); return {date:`${yyyy}${mm}${dd}`, time:`${HH}${MM}`}; }
    function fmtName(tpl, base, index){ const {date,time}=nowStamp(); const sku = csvMap.get(base) || csvMap.get(base.toLowerCase()) || ''; return (tpl||'{base}-{index}').replaceAll('{base}', base).replaceAll('{index}', pad(index)).replaceAll('{date}', date).replaceAll('{time}', time).replaceAll('{sku}', sku); }
    function updateSummary(){ summary.textContent = `${items.length} files`;
      countEl.textContent = items.length ? `${items.length} file${items.length>1?'s':''} queued` : ''; }

    function resetUI(){ items=[]; files=[]; repoList.innerHTML=''; updateSummary(); bar.style.width='0%'; statusEl.textContent='Idle.'; errorsEl.style.display='none'; errorsEl.textContent=''; }

    // ---------- Repository (List/Gallery) ----------
    function renderRepo(){
      const view = viewModeSel.value;
      thumbPill.style.display = view==='gallery' ? 'inline-flex' : 'none';
      if(view==='list') renderList(); else renderGallery();
    }

    function renderList(){
      const rows = items.map((it, i)=> `<tr data-id="${it.id}"><td>${pad(i+1,2)}</td><td>${it.name}</td><td class="muted">${kb(it.size)}</td><td><span class="status ${it.statusClass}">${it.statusText}</span></td><td><button class="btn secondary" data-act="remove" data-id="${it.id}" style="width:auto;">Remove</button></td></tr>`).join('');
      repoList.innerHTML = `<table class="list"><thead><tr><th>#</th><th>Name</th><th>Size</th><th>Status</th><th></th></tr></thead><tbody>${rows}</tbody></table>`;
      repoList.querySelectorAll('[data-act="remove"]').forEach(btn=> btn.addEventListener('click', ()=> removeItem(btn.getAttribute('data-id'))));
    }

    function renderGallery(){
      const grid = document.createElement('div'); grid.className='grid';
      for(const it of items){
        const card = document.createElement('div'); card.className='card'; card.setAttribute('data-id', it.id);
        const pict = document.createElement('div'); pict.className='thumb'; pict.textContent='File';
        const name = document.createElement('div'); name.className='muted'; name.textContent = it.name;
        const rm = document.createElement('button'); rm.className='x'; rm.textContent='âœ•'; rm.title='Remove'; rm.addEventListener('click', ()=> removeItem(it.id));
        card.append(pict, name, rm); grid.appendChild(card);
      }
      repoList.innerHTML=''; repoList.appendChild(grid);
      // kick lazy previews only if user wants them
      if(thumbModeSel.value!=='off') scheduleThumbs();
    }

    function removeItem(id){ items = items.filter(x=> x.id!==id); files = files.filter(f=> f._id!==id); renderRepo(); updateSummary(); }

    function addFiles(list){
      const startLen = items.length;
      for(const f of list){ if(!f.type && !/\.heic$/i.test(f.name)) continue; const id = crypto.randomUUID(); f._id=id; files.push(f); items.push({id, file:f, name:f.name, size:f.size, statusText:'Queued', statusClass:''}); }
      updateSummary();
      if(items.length!==startLen) renderRepo();
    }

    // ---------- Thumbnails (on demand, very light) ----------
    let thumbQueue = [];
    let thumbBusy = false;
    function scheduleThumbs(){ if(viewModeSel.value!=='gallery') return; if(thumbModeSel.value==='auto' && items.length>=40) return; if(thumbModeSel.value==='off') return; thumbQueue = items.slice(0); runThumbPump(); }

    function runThumbPump(){ if(thumbBusy) return; thumbBusy=true; const step=()=>{ const task = thumbQueue.shift(); if(!task){ thumbBusy=false; return; } // generate tiny preview 256px on worker
        genThumb(task).then(url=>{ const card = repoList.querySelector(`[data-id="${task.id}"] .thumb`); if(card) { card.style.backgroundImage = `url(${url})`; card.style.backgroundSize='cover'; card.textContent=''; } }).catch(()=>{}).finally(()=> requestIdleCallback(step, {timeout:200})); }; requestIdleCallback(step, {timeout:200}); }

    // Separate worker for tiny previews (kept to 1 at a time via pump)
    const thumbWorkerBlob = new Blob([`
      importScripts('https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js');
      self.onmessage = async (e)=>{ const {id, file} = e.data; try{ const inter = await heic2any({ blob:file, toType:'image/png' }); const bmp = await createImageBitmap(inter); const m=Math.max(bmp.width,bmp.height); const s=Math.min(1, 256/m); const w=Math.max(1,Math.round(bmp.width*s)); const h=Math.max(1,Math.round(bmp.height*s)); const c=new OffscreenCanvas(w,h); const ctx=c.getContext('2d'); ctx.drawImage(bmp,0,0,w,h); const out = await c.convertToBlob({type:'image/png'}); const r = await out.arrayBuffer(); self.postMessage({id, ok:true, buf:r}, [r]); } catch(err){ self.postMessage({id, ok:false}); } };`], {type:'text/javascript'});
    const thumbWorkerURL = URL.createObjectURL(thumbWorkerBlob);
    const thumbWorker = new Worker(thumbWorkerURL);
    const thumbResolvers = new Map();
    thumbWorker.onmessage = (e)=>{ const {id, ok, buf} = e.data; const res = thumbResolvers.get(id); if(!res) return; thumbResolvers.delete(id); if(ok){ const blob = new Blob([buf], {type:'image/png'}); const url = URL.createObjectURL(blob); res.resolve(url); } else { res.reject(); } };
    function genThumb(item){ return new Promise((resolve,reject)=>{ thumbResolvers.set(item.id,{resolve,reject}); try{ thumbWorker.postMessage({id:item.id, file:item.file}); }catch(e){ thumbResolvers.delete(item.id); reject(e); } }); }

    // ---------- CSV mapping ----------
    csvInput.addEventListener('change', async (e)=>{ csvMap.clear(); const file=e.target.files?.[0]; if(!file) return; const text=await file.text(); const rows=text.split(/\r?\n/).filter(Boolean).map(r=> r.split(',').map(s=> s.trim())); if(!rows.length) return; const header=rows[0].map(h=> h.toLowerCase()); const iOrig=header.indexOf('original'); const iNew=header.indexOf('new'); const iName=header.indexOf('name'); const iSku=header.indexOf('sku'); for(let i=1;i<rows.length;i++){ const r=rows[i]; if(iOrig>-1&&iNew>-1) csvMap.set(r[iOrig], r[iNew]); else if(iName>-1&&iSku>-1) csvMap.set(r[iName], r[iSku]); } statusEl.textContent = `CSV loaded: ${csvMap.size} mapping(s).`; });

    // ---------- DnD + picker ----------
    drop.addEventListener('dragover', (e)=>{ e.preventDefault(); drop.classList.add('drag'); });
    drop.addEventListener('dragleave', ()=> drop.classList.remove('drag'));
    drop.addEventListener('drop', (e)=>{ e.preventDefault(); drop.classList.remove('drag'); if(e.dataTransfer?.files) addFiles(e.dataTransfer.files); });
    picker.addEventListener('change', (e)=> addFiles(e.target.files));
    drop.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); picker.click(); }});

    // ---------- Keyboard shortcuts ----------
    document.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='o'){ e.preventDefault(); picker.click(); } if((e.ctrlKey||e.metaKey) && e.key==="Enter"){ e.preventDefault(); convertBtn.click(); } if(e.key==='Delete'){ clearBtn.click(); } });

    // ---------- List/Gallery switching ----------
    viewModeSel.addEventListener('change', ()=>{ renderRepo(); persistSettings(); });
    thumbModeSel.addEventListener('change', ()=>{ renderRepo(); persistSettings(); });

    // ---------- Conversion (worker pool, optimized path) ----------
    function chooseIntermediateType(toType, willResize){ return willResize ? 'image/png' : toType; } // avoid double-lossy

    const convWorkerBlob = new Blob([`
      importScripts('https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js');
      self.onmessage = async (e)=>{
        const { id, file, toType, quality, maxSize } = e.data;
        try{
          const willResize = !!maxSize;
          const interType = willResize ? 'image/png' : toType;
          const inter = await heic2any({ blob:file, toType: interType, quality });
          if(!willResize){ self.postMessage({ id, ok:true, buf: await inter.arrayBuffer() }, [await inter.arrayBuffer()]); return; }
          const bmp = await createImageBitmap(inter);
          const m = Math.max(bmp.width, bmp.height);
          const s = Math.min(1, maxSize / m);
          const w = Math.max(1, Math.round(bmp.width * s));
          const h = Math.max(1, Math.round(bmp.height * s));
          const c = new OffscreenCanvas(w, h);
          const ctx = c.getContext('2d');
          ctx.drawImage(bmp, 0, 0, w, h);
          const out = await c.convertToBlob({ type: toType, quality });
          const buf = await out.arrayBuffer();
          self.postMessage({ id, ok:true, buf }, [buf]);
        }catch(err){ self.postMessage({ id, ok:false, error: err?.message || String(err) }); }
      };
    `], {type:'text/javascript'});
    const convWorkerURL = URL.createObjectURL(convWorkerBlob);
    class Pool{ constructor(n){ this.n=n; this.ws=[]; this.free=[]; this.seq=0; this.map=new Map(); }
      init(){ for(let i=0;i<this.n;i++){ const w=new Worker(convWorkerURL); w.onmessage=(e)=>{ const {id, ok, buf, error}=e.data; const r=this.map.get(id); if(!r) return; this.map.delete(id); this.free.push(w); if(ok){ const blob=new Blob([buf]); r.resolve(blob); } else r.reject(new Error(error)); }; this.ws.push(w); this.free.push(w);} }
      run(data){ const id=++this.seq; return new Promise((resolve,reject)=>{ const go=()=>{ if(!poolLive) return reject(new Error('cancelled')); if(this.free.length){ const w=this.free.pop(); this.map.set(id,{resolve,reject}); try{ w.postMessage({ ...data, id }); }catch(e){ this.free.push(w); this.map.delete(id); reject(e);} } else { setTimeout(go, 10); } }; go(); }); }
      kill(){ this.ws.forEach(w=>{ try{w.terminate();}catch{} }); this.ws=[]; this.free=[]; this.map.clear(); }
    }

    let poolLive = true; let pool = null;
    function startPool(){ poolLive=true; const cores = navigator.hardwareConcurrency || 4; const n=Math.min(4, Math.max(2, Math.floor(cores/2))); pool=new Pool(n); pool.init(); return pool; }
    function stopPool(){ poolLive=false; if(pool){ pool.kill(); pool=null; } }

    function ext(to){ return to==='image/png'?'png':(to==='image/webp'?'webp':'jpg'); }

    convertBtn.addEventListener('click', async ()=>{
      if (!items.length) return alert('Add some HEIC files first.');
      errorsEl.style.display='none'; errorsEl.textContent='';
      abort.cancelled=false; cancelBtn.disabled=false; convertBtn.disabled=true; clearBtn.disabled=true; csvInput.disabled=true; picker.disabled=true;
      bar.style.width='0%'; document.querySelector('.progress').classList.remove('cancelling');

      // pause thumb generation during heavy work
      thumbQueue=[]; thumbBusy=false;

      // apply speed mode quick defaults
      maybeApplySpeedMode();

      const toType = formatSel.value; const isLossy = toType==='image/jpeg'||toType==='image/webp'; const quality = isLossy ? parseInt(qualityRange.value,10)/100 : undefined; const max=parseInt(maxSize.value,10)||0;
      const willResize = !!max;
      const zip = new JSZip(); let done=0; const total = items.length; const {date,time}=nowStamp(); const start=performance.now(); const zipName = `converted_${date}_${time}.zip`;

      // mark statuses
      items.forEach(it=>{ it.statusText='Queued'; it.statusClass=''; }); renderRepo();

      const p = startPool();
      let index=0; let cursor=0; let running=0; const k=p.ws.length;

      function updateRow(id, text, cls){ const it = items.find(x=>x.id===id); if(it){ it.statusText=text; it.statusClass=cls||it.statusClass; if(viewModeSel.value==='list'){ const row = repoList.querySelector(`tr[data-id="${id}"] .status`); if(row){ row.textContent=text; row.className = 'status '+(cls||''); } } } }

      const updateStatus = ()=>{ const elapsed=(performance.now()-start)/1000; const per=done? (elapsed/done):0; const remain=Math.max(0,total-done); const eta=done? Math.ceil(per*remain)+'s':'â€”'; statusEl.textContent = `â³ Converting ${done}/${total}â€¦ ETA ${eta}`; };

      const next = async ()=>{
        if(abort.cancelled) return; if(cursor>=items.length) return;
        const it = items[cursor++]; running++; updateRow(it.id,'Converting','run');
        try{
          const blob = await p.run({ file: it.file, toType, quality, maxSize: willResize? max : 0 });
          const base = it.name.replace(/\.[^.]+$/, ''); const out = fmtName(baseName.value, base, ++index);
          zip.file(`${out}.${ext(toType)}`, blob); updateRow(it.id,'Done','ok');
        }catch(err){ errorsEl.style.display='block'; errorsEl.textContent = `Failed on ${it.name}: ${err?.message||err}`; updateRow(it.id,'Error','err'); }
        done++; bar.style.width = `${Math.round((done/total)*100)}%`; updateStatus(); running--; if(!abort.cancelled) next();
      };

      for(let i=0;i<Math.min(k, items.length); i++) next();
      while((cursor<items.length || running>0) && !abort.cancelled){ await new Promise(r=> setTimeout(r, 50)); }

      stopPool();

      if(!abort.cancelled){ statusEl.textContent='ðŸ“¦ Creating zipâ€¦'; const blob=await zip.generateAsync({type:'blob'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=zipName; a.target='_self'; a.rel='noopener'; a.style.display='none'; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },1000); statusEl.textContent=`âœ… Done. Downloaded ${zipName}`; }
      else { statusEl.textContent='âœ‹ Cancelled.'; }

      cancelBtn.disabled=true; convertBtn.disabled=false; clearBtn.disabled=false; csvInput.disabled=false; picker.disabled=false;
    });

    cancelBtn.addEventListener('click', ()=>{ abort.cancelled=true; document.querySelector('.progress').classList.add('cancelling'); statusEl.textContent = 'Cancellingâ€¦'; stopPool(); });

    clearBtn.addEventListener('click', ()=>{ stopPool(); resetUI(); });

    // ---------- Init ----------
    resetUI(); renderRepo();

    // ---------- Service Worker (safer cache) ----------
    if('serviceWorker' in navigator){ const swCode = `const CACHE='heicconv-v4';self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./'])));self.skipWaiting();});self.addEventListener('activate',e=>self.clients.claim());self.addEventListener('fetch',e=>{const r=e.request;const u=new URL(r.url);if(r.method!=='GET'||u.origin!==location.origin){return;}e.respondWith(caches.match(r).then(m=>m||fetch(r).then(resp=>{const copy=resp.clone();caches.open(CACHE).then(c=>c.put(r,copy)).catch(()=>{});return resp;}).catch(()=>m)));});`; const blob=new Blob([swCode],{type:'text/javascript'}); const url=URL.createObjectURL(blob); navigator.serviceWorker.register(url).catch(()=>{}); }
  </script>
</body>
</html>
